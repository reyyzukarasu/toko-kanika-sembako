<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keranjang Saya - Toko Kanika Sembako</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      * {
        font-family: "Inter", sans-serif;
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .hover-scale {
        transition: transform 0.2s ease;
      }

      .hover-scale:hover {
        transform: scale(1.02);
      }

      /* Custom Checkbox Style */
      .custom-checkbox {
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
      }

      .custom-checkbox:checked {
        background-color: #2563eb;
        border-color: #2563eb;
      }

      /* Custom Number Input */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        opacity: 1;
        height: 1.5em;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <h1
            class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent"
          >
            Keranjang Saya
          </h1>
          <a
            href="index.html"
            class="text-gray-600 hover:text-blue-600 transition-colors duration-200 flex items-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            Kembali ke Beranda
          </a>
        </div>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Cart List -->
      <div id="cart-list" class="space-y-4 mb-8"></div>

      <!-- Order Section -->
      <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-sm p-6 mt-6">
        <div
          class="flex flex-col sm:flex-row justify-between items-center gap-4"
        >
          <div
            id="total-section"
            class="text-xl font-semibold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent"
          ></div>
          <div class="flex flex-col gap-3 w-full sm:w-auto">
            <button
              id="order-btn"
              class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 w-full sm:w-auto"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"
                />
              </svg>
              Order via WhatsApp
            </button>
            <button
              id="confirm-clear"
              class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors duration-200 hidden w-full sm:w-auto"
            >
              Saya sudah order, kosongkan keranjang
            </button>
          </div>
        </div>

        <!-- Order Note -->
        <p class="mt-6 text-gray-600 text-center sm:text-right">
          Setelah mengirim order, mohon
          <span class="font-medium text-gray-800"
            >tunggu konfirmasi dari admin</span
          >
          sebelum melakukan pembayaran ya ðŸ˜Š
        </p>
      </div>
    </main>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://qxmhkdvfbissaomwjidi.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4bWhrZHZmYmlzc2FvbXdqaWRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MjA3MDMsImV4cCI6MjA3MjA5NjcwM30.Grk1qCgcB-JqCSEoy_E4J_8aWxCWbe8pC49jm_kfLyY"
      );

      // Utility function for user profiles
      async function getUserProfile(supabase) {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        if (!session) return null;

        const { data, error } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", session.user.id)
          .single();

        if (error) {
          console.error("Error fetching profile:", error);
          return null;
        }

        return data;
      }

      const cartList = document.getElementById("cart-list");
      const orderBtn = document.getElementById("order-btn");
      const confirmClearBtn = document.getElementById("confirm-clear");
      let userId = null;

      // [Your existing JavaScript code here]
      // Check login
      async function checkLogin() {
        const { data, error } = await supabase.auth.getUser();
        if (!data?.user) {
          alert("Login dulu ya sebelum buka keranjang.");
          window.location.href = "login.html";
          return;
        }
        userId = data.user.id;
      }

      // Load cart items
      async function loadCart() {
        cartList.innerHTML = `
          <div class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          </div>
        `;

        const { data, error } = await supabase
          .from("cart_items")
          .select("id, qty, product:products(name, price, image_url)")
          .eq("user_id", userId);

        if (error || !data.length) {
          cartList.innerHTML = `
            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-sm p-8 text-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
              <p class="text-gray-500 text-lg">Keranjang kamu kosong.</p>
              <a href="index.html" class="inline-block mt-4 text-blue-600 hover:text-blue-700 transition-colors duration-200">
                Yuk belanja dulu!
              </a>
            </div>
          `;
          orderBtn.disabled = true;
          orderBtn.classList.add("opacity-50", "cursor-not-allowed");
          confirmClearBtn.classList.add("hidden");
          return;
        } else {
          orderBtn.disabled = false;
          orderBtn.classList.remove("opacity-50", "cursor-not-allowed");
        }

        cartList.innerHTML = data
          .map(
            (item) => `
          <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-sm overflow-hidden hover-scale fade-in">
            <div class="p-4 flex items-center justify-between gap-4">
              <div class="flex items-center gap-4">
                <input type="checkbox" data-id="${item.id}" data-name="${
              item.product.name
            }" 
                       class="cart-check custom-checkbox"/>
                <img src="${item.product.image_url}" 
                     class="w-16 h-16 object-cover rounded-lg"
                     alt="${item.product.name}"/>
                <div>
                  <h3 class="font-semibold text-gray-800">${
                    item.product.name
                  }</h3>
                  <p class="item-price text-sm text-gray-500">
                    Rp${Number(item.product.price).toLocaleString(
                      "id-ID"
                    )} / item
                  </p>
                  <div class="flex items-center gap-2 mt-2">
                    <label class="text-sm text-gray-500">Jumlah:</label>
                    <input type="number" min="1" value="${item.qty}" data-id="${
              item.id
            }" 
                           class="qty-input border border-gray-200 w-20 px-2 py-1 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                  </div>
                </div>
              </div>

              <button data-id="${item.id}" 
                      class="delete-cart bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">
                Hapus
              </button>
            </div>
          </div>
        `
          )
          .join("");

        updateTotalHarga();

        // Event listeners
        setupEventListeners();
      }

      function setupEventListeners() {
        // Delete buttons
        document.querySelectorAll(".delete-cart").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!confirm("Yakin ingin menghapus produk ini dari keranjang?"))
              return;

            btn.innerHTML = `
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            `;

            await supabase.from("cart_items").delete().eq("id", id);
            loadCart();
          });
        });

        // Quantity inputs
        document.querySelectorAll(".qty-input").forEach((input) => {
          input.addEventListener("input", async () => {
            const id = input.getAttribute("data-id");
            const newQty = parseInt(input.value);

            if (isNaN(newQty) || newQty <= 0) return;

            await supabase
              .from("cart_items")
              .update({ qty: newQty })
              .eq("id", id);
            updateTotalHarga();
          });

          input.addEventListener("blur", () => {
            updateTotalHarga();
          });
        });

        // Checkboxes
        document.querySelectorAll(".cart-check").forEach((check) => {
          check.addEventListener("change", () => {
            updateTotalHarga();
          });
        });
      }

      function updateTotalHarga() {
        let total = 0;

        document.querySelectorAll(".cart-check:checked").forEach((checkbox) => {
          const parent = checkbox.closest(".flex");
          const priceText = parent.querySelector(".item-price").textContent;
          const harga = parseInt(priceText.replace(/[^\d]/g, ""));
          const qtyInput = parent.querySelector(".qty-input");
          const qty = parseInt(qtyInput.value);

          if (!isNaN(qty)) {
            total += qty * harga;
          }
        });

        document.getElementById("total-section").textContent =
          "Total: Rp" + total.toLocaleString("id-ID");
      }

      orderBtn.addEventListener("click", async () => {
        const selected = [...document.querySelectorAll(".cart-check:checked")];
        if (selected.length === 0) {
          alert("Pilih dulu produk yang ingin dipesan.");
          return;
        }

        const profile = await getUserProfile(supabase);
        if (!profile?.name || !profile?.address) {
          alert("Lengkapi nama dan alamatmu dulu di halaman utama.");
          window.location.href = "index.html";
          return;
        }

        let message = `Halo Admin, saya ingin memesan:\n`;
        let total = 0;

        selected.forEach((checkbox) => {
          const name = checkbox.getAttribute("data-name");
          const parent = checkbox.closest(".flex");
          const qtyInput = parent.querySelector(".qty-input");
          const priceText = parent.querySelector(".item-price").textContent;
          const harga = parseInt(priceText.replace(/[^\d]/g, ""));
          const qty = parseInt(qtyInput.value);
          const subtotal = qty * harga;

          total += subtotal;
          message += `- ${qty}x ${name} = Rp${subtotal.toLocaleString(
            "id-ID"
          )}\n`;
        });

        message += `\nSubtotal: Rp${total.toLocaleString("id-ID")}`;
        message += `\n\nNama: ${profile.name}`;
        message += `\nAlamat: ${profile.address}`;
        message += `\n\nSaya akan menunggu konfirmasi dari admin sebelum melakukan pembayaran ya.`;

        const whatsappNumber = "6282318571266";
        const encoded = encodeURIComponent(message);
        window.open(
          `https://wa.me/${whatsappNumber}?text=${encoded}`,
          "_blank"
        );

        confirmClearBtn.classList.remove("hidden");
      });

      confirmClearBtn.addEventListener("click", async () => {
        const selected = [...document.querySelectorAll(".cart-check:checked")];

        confirmClearBtn.disabled = true;
        confirmClearBtn.innerHTML = `
          <svg class="animate-spin h-5 w-5 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Mengosongkan keranjang...
        `;

        for (const checkbox of selected) {
          const id = checkbox.getAttribute("data-id");
          await supabase.from("cart_items").delete().eq("id", id);
        }

        alert(
          "Produk berhasil dihapus dari keranjang.\nKamu akan diarahkan ke halaman utama."
        );
        confirmClearBtn.classList.add("hidden");
        window.location.href = "index.html";
      });

      // Initialize
      async function start() {
        await checkLogin();
        if (userId) await loadCart();
      }
      start();
    </script>
  </body>
</html>
